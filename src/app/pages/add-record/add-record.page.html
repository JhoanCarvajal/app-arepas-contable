<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Agregar Registro</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="openBoxSelectionActionSheet()">
        <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Agregar Registro</ion-title>
    </ion-toolbar>
  </ion-header> -->

  <form (ngSubmit)="onSubmit()" #expenseForm="ngForm">
    <ion-list [inset]="true">
      <ion-item class="rounded-input">
        <ion-label>Fecha del Registro</ion-label>
        <ion-datetime-button datetime="datetime"></ion-datetime-button>
      </ion-item>
      <ion-item class="rounded-input">
        <ion-input
          class="money-input"
          label="Ganancias del DÃ­a"
          labelPlacement="stacked"
          type="number"
          placeholder="1250.00"
          fill="outline"
          [required]="true"
          (ionInput)="handleInput($event, dailyEarnings)"
          [value]="dailyEarnings()">
            <div slot="start">$</div>
        </ion-input>
      </ion-item>
    </ion-list>

    <!-- Este es un modal para mostrar el calendario de la fecha del registrok -->
    <ion-modal [keepContentsMounted]="true">
      <ng-template>
        <ion-datetime
          id="datetime"
          presentation="date"
          [showDefaultButtons]="true"
          (ionChange)="recordDate.set(($event.detail.value ?? '') + '')"
          [value]="recordDate()"
          done-text="Hecho"
          cancel-text="Cancelar"
          >
        </ion-datetime>
      </ng-template>
    </ion-modal>

    <!-- Dynamic Box Controls Section -->
    @if (selectedBoxControls().size > 0) {
      <ion-list [inset]="true">
        <ion-list-header>
          <ion-label>Gastos por Caja</ion-label>
        </ion-list-header>

        @for (controlEntry of selectedBoxControls(); track controlEntry[0]) {
          @let boxId = controlEntry[0];
          @let control = controlEntry[1];
          <ion-item>
            <!-- <ion-label>{{ control.boxName }}</ion-label> -->
            <ng-container *ngIf="control.cantPriceFields; else totalOnly">
              <ion-grid>
                <ion-row class="ion-align-items-center">
                  <!-- <ion-col size="12" size-sm="5"><ion-label>{{ control.boxName }}</ion-label></ion-col> -->
                  <ion-col size="4" size-sm="3.5">
                    <ion-item class="rounded-small" lines="none">
                      <ion-input label="{{ control.boxName }}" labelPlacement="stacked" type="number" placeholder="Cant." fill="outline"
                        [value]="control.quantity"
                        (ionInput)="handleDynamicInput(boxId, 'quantity', $event)">
                      </ion-input>
                    </ion-item>
                  </ion-col>
                  <ion-col size="8" size-sm="3.5">
                    <ion-item class="rounded-small" lines="none">
                      <ion-input type="number" placeholder="Precio" fill="outline"
                        [value]="control.price"
                        (ionInput)="handleDynamicInput(boxId, 'price', $event)">
                        <div slot="start">$</div>
                      </ion-input>
                    </ion-item>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ng-container>
            <ng-template #totalOnly>
              <ion-input label="{{ control.boxName }}" labelPlacement="stacked" type="number" placeholder="Total" fill="outline"
                [value]="control.total"
                (ionInput)="handleDynamicInput(boxId, 'total', $event)">
                <div slot="start">$</div>
              </ion-input>
            </ng-template>
          </ion-item>
          <!-- <ion-item>
            <ion-input label="Nota" labelPlacement="stacked" type="text" placeholder="Nota (opcional)" fill="outline"
              [value]="control.note"
              (ionInput)="handleDynamicInput(boxId, 'note', $event)">
            </ion-input>
          </ion-item> -->
        }
      </ion-list>
    }

    <ion-card class="ion-margin">
        <ion-card-content>
            <ion-item lines="none">
                <ion-label>Total de Egresos:</ion-label>
                <ion-text color="danger" slot="end">
                    <h2 class="ion-no-margin">${{ totalSelectedBoxesExpenses() | number:'1.0-0' }}</h2>
                </ion-text>
            </ion-item>
            <ion-item lines="none">
                <ion-label><strong>Beneficio Neto:</strong></ion-label>
                <ion-text [color]="netProfit() >= 0 ? 'success' : 'danger'" slot="end">
                    <h2 class="ion-no-margin">${{ netProfit() | number:'1.0-0' }}</h2>
                </ion-text>
            </ion-item>
        </ion-card-content>
    </ion-card>

    <div class="ion-padding">
       <ion-button
        type="submit"
        expand="block"
        [disabled]="dailyEarnings() === null || (dailyEarnings() ?? 0) < 0">
        Guardar Registro
      </ion-button>
    </div>
  </form>
</ion-content>
